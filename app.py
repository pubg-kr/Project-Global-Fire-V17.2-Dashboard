import streamlit as st
import yfinance as yf
import pandas as pd
import plotly.graph_objects as go
import json
import os
import requests
from bs4 import BeautifulSoup

# ==========================================
# 0. ë°ì´í„° ì˜êµ¬ ì €ì¥ (Persistence)
# ==========================================
DATA_FILE = "portfolio_data.json"

def load_data():
    """JSON íŒŒì¼ì—ì„œ ë°ì´í„° ë¡œë“œ, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ë°˜í™˜"""
    default_data = {
        "monthly_contribution": 5000000,
        "a_tqqq_qty": 1000.0,
        "a_tqqq_avg": 80000,
        "a_usd_qty": 0.0,
        "a_usd_avg": 0,
        "a_cash_krw": 0,
        "a_cash_usd": 0,
        "b_tqqq_qty": 200.0,
        "b_tqqq_avg": 85000,
        "b_usd_qty": 0.0,
        "b_usd_avg": 0,
        "b_cash_krw": 1000000,
        "b_cash_usd": 15000,
        "c_cash_krw": 0
    }
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, "r") as f:
                loaded = json.load(f)
                # ë§ˆì´ê·¸ë ˆì´ì…˜: êµ¬ë²„ì „ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³‘í•©
                for k, v in default_data.items():
                    if k not in loaded:
                        loaded[k] = v
                return loaded
        except:
            return default_data
    return default_data

def save_data():
    """í˜„ì¬ Session State ê°’ì„ JSONìœ¼ë¡œ ì €ì¥"""
    data = {
        "monthly_contribution": st.session_state.monthly_contribution,
        "a_tqqq_qty": st.session_state.a_tqqq_qty,
        "a_tqqq_avg": st.session_state.a_tqqq_avg,
        "a_usd_qty": st.session_state.a_usd_qty,
        "a_usd_avg": st.session_state.a_usd_avg,
        "a_cash_krw": st.session_state.a_cash_krw,
        "a_cash_usd": st.session_state.a_cash_usd,
        "b_tqqq_qty": st.session_state.b_tqqq_qty,
        "b_tqqq_avg": st.session_state.b_tqqq_avg,
        "b_usd_qty": st.session_state.b_usd_qty,
        "b_usd_avg": st.session_state.b_usd_avg,
        "b_cash_krw": st.session_state.b_cash_krw,
        "b_cash_usd": st.session_state.b_cash_usd,
        "c_cash_krw": st.session_state.c_cash_krw
    }
    with open(DATA_FILE, "w") as f:
        json.dump(data, f)

# ==========================================
# 1. ì„¤ì • ë° ìƒìˆ˜
# ==========================================
st.set_page_config(page_title="Global Fire CRO V22.4", layout="wide", page_icon="ğŸ”¥")

PHASE_CONFIG = {
    0: {"limit": 100000000, "target_stock": 0.9, "target_cash": 0.1, "name": "Phase 0 (Seed)"},
    1: {"limit": 300000000, "target_stock": 0.8, "target_cash": 0.2, "name": "Phase 1 (Standard)"},
    2: {"limit": 700000000, "target_stock": 0.7, "target_cash": 0.3, "name": "Phase 2 (Defense)"},
    3: {"limit": 1500000000, "target_stock": 0.6, "target_cash": 0.4, "name": "Phase 3 (Critical Mass)"},
    4: {"limit": 2500000000, "target_stock": 0.5, "target_cash": 0.5, "name": "Phase 4 (Retirement Prep)"},
    5: {"limit": float('inf'), "target_stock": 0.4, "target_cash": 0.6, "name": "Phase 5 (Final Exit)"}
}

PROTOCOL_TEXT = """
### ğŸ“œ Master Protocol (ìš”ì•½) - Ver 22.4 Daily Defense
1.  **[í—Œë²•] ì†ì‹¤ ì¤‘ ë§¤ë„ ê¸ˆì§€:** ê³„ì¢Œê°€ ë§ˆì´ë„ˆìŠ¤ë©´ RSIê°€ 100ì´ì–´ë„ ì ˆëŒ€ íŒ”ì§€ ì•ŠëŠ”ë‹¤.
2.  **[ê²¨ìš¸] 200ì¼ì„  ë¶•ê´´:** QQQê°€ ì¼ë´‰ 200ì„  ì•„ë˜ë¡œ ë‚´ë ¤ê°€ë©´ 'ê²¨ìš¸' ì„ í¬. (í˜„ê¸ˆ ë¹„ì¤‘ 50% ë¯¸ë§Œì¼ ë•Œë§Œ í™•ë³´)
3.  **[ë´„ì˜ ê·€í™˜] 4ì£¼ ë¶„í•  ë§¤ìˆ˜:** ê²¨ìš¸ â†’ ë´„ ì „í™˜ ì‹œ, 1ê°œì›”ê°„ ë¶„í•  ë§¤ìˆ˜ë¡œ ì‹ ì¤‘í•˜ê²Œ ì§„ì…í•œë‹¤.
4.  **[ìŠ¤ë‚˜ì´í¼] ì—­í”¼ë¼ë¯¸ë“œ:** í•˜ë½í• ìˆ˜ë¡ ë” ë§ì´ ì‚°ë‹¤ (10% -> 20% -> 30% -> 40%).
5.  **[ê´‘ê¸°] RSI 80:** (ë´„ ì‹œì¦Œ ì¤‘) í˜„ê¸ˆ ë¹„ì¤‘ì„ Target + 10%ê¹Œì§€ ëŠ˜ë¦°ë‹¤.
6.  **[ë“€ì–¼] 50:50:** TQQQì™€ USD ë¹„ì¤‘ì´ 10%p ì´ìƒ ë²Œì–´ì§€ë©´ ë¦¬ë°¸ëŸ°ì‹±.
"""

# ==========================================
# 2. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
# ==========================================
def calculate_indicators(df):
    """ë°ì´í„°í”„ë ˆì„(ì£¼/ì›”ë´‰)ì„ ë°›ì•„ RSIì™€ MDDë¥¼ ê³„ì‚°í•˜ì—¬ ë°˜í™˜"""
    if df.empty: return 0, 0
    
    # RSI ê³„ì‚°
    delta = df['Close'].diff()
    gain = (delta.where(delta > 0, 0)).fillna(0)
    loss = (-delta.where(delta < 0, 0)).fillna(0)
    avg_gain = gain.rolling(window=14).mean()
    avg_loss = loss.rolling(window=14).mean()
    rs = avg_gain / avg_loss
    df['RSI'] = 100 - (100 / (1 + rs))
    
    # MDD ê³„ì‚° (1ë…„/52ì£¼ ê¸°ì¤€)
    window = 52 if len(df) >= 52 else len(df)
    df['Roll_Max'] = df['Close'].rolling(window=window, min_periods=1).max()
    df['DD'] = (df['Close'] / df['Roll_Max']) - 1.0
    
    return float(df['RSI'].iloc[-1]), float(df['DD'].iloc[-1])

def get_market_data():
    try:
        # QQQ (ì¼ë´‰/ì£¼ë´‰/ì›”ë´‰)
        qqq_dy = yf.download("QQQ", interval="1d", period="1y", progress=False, auto_adjust=False)
        qqq_wk = yf.download("QQQ", interval="1wk", period="2y", progress=False, auto_adjust=False)
        qqq_mo = yf.download("QQQ", interval="1mo", period="5y", progress=False, auto_adjust=False)
        
        # TQQQ (ì£¼ë´‰/ì›”ë´‰)
        tqqq_wk = yf.download("TQQQ", interval="1wk", period="2y", progress=False, auto_adjust=False)
        tqqq_mo = yf.download("TQQQ", interval="1mo", period="5y", progress=False, auto_adjust=False)

        # USD (ì£¼ë´‰/ì›”ë´‰) - ProShares Ultra Semiconductors
        usd_wk = yf.download("USD", interval="1wk", period="2y", progress=False, auto_adjust=False)
        usd_mo = yf.download("USD", interval="1mo", period="5y", progress=False, auto_adjust=False)
        
        # [Ver 22.5] SOXX (ë°˜ë„ì²´ ì§€ìˆ˜ - ê³„ì ˆ íŒë‹¨ìš© & ì°¨íŠ¸ìš©)
        soxx_dy = yf.download("SOXX", interval="1d", period="1y", progress=False, auto_adjust=False)
        soxx_wk = yf.download("SOXX", interval="1wk", period="2y", progress=False, auto_adjust=False)
        soxx_mo = yf.download("SOXX", interval="1mo", period="5y", progress=False, auto_adjust=False)
        
        # ë§¤í¬ë¡œ ì§€í‘œ (VIX, 10ë…„ë¬¼, 3ê°œì›”ë¬¼) - 1ë…„ì¹˜ ë°ì´í„° (ì¶”ì„¸ ë¶„ì„ìš©)
        vix = yf.download("^VIX", period="1y", progress=False, auto_adjust=False)
        tnx = yf.download("^TNX", period="1y", progress=False, auto_adjust=False) # 10ë…„ë¬¼
        irx = yf.download("^IRX", period="1y", progress=False, auto_adjust=False) # 3ê°œì›”ë¬¼
        
        # í™˜ìœ¨
        exch = yf.download("KRW=X", period="1d", progress=False, auto_adjust=False)
        
        if qqq_wk.empty or exch.empty or tqqq_wk.empty or usd_wk.empty or soxx_dy.empty: return None

        # MultiIndex ì •ë¦¬
        for d in [qqq_dy, qqq_wk, qqq_mo, tqqq_wk, tqqq_mo, usd_wk, usd_mo, soxx_dy, soxx_wk, soxx_mo, exch, vix, tnx, irx]:
            if isinstance(d.columns, pd.MultiIndex): d.columns = d.columns.get_level_values(0)

        current_rate = float(exch['Close'].iloc[-1])
        
        # QQQ ì§€í‘œ & ì´ë™í‰ê· ì„ 
        qqq_price = float(qqq_wk['Close'].iloc[-1])
        
        # MA ê³„ì‚° (ì¼/ì£¼/ì›”) - QQQ & SOXX & TQQQ & USD ì¼ê´„ ì²˜ë¦¬
        for d in [qqq_dy, qqq_wk, qqq_mo, soxx_dy, soxx_wk, soxx_mo, tqqq_wk, tqqq_mo, usd_wk, usd_mo]:
            d['MA20'] = d['Close'].rolling(window=20).mean()
            d['MA40'] = d['Close'].rolling(window=40).mean() # 40ì£¼ì„  ì¶”ê°€ (Winter Protocol)
            d['MA60'] = d['Close'].rolling(window=60).mean()
            d['MA200'] = d['Close'].rolling(window=200).mean() # 200ì¼ì„  ì¶”ê°€
            calculate_indicators(d) # RSI, MDD ê³„ì‚°

        qqq_rsi_wk = float(qqq_wk['RSI'].iloc[-1])
        qqq_mdd = float(qqq_wk['DD'].iloc[-1])
        qqq_rsi_mo = float(qqq_mo['RSI'].iloc[-1])
        
        # TQQQ ì§€í‘œ
        tqqq_price = float(tqqq_wk['Close'].iloc[-1])
        tqqq_rsi_wk, tqqq_mdd = calculate_indicators(tqqq_wk)
        tqqq_rsi_mo, _ = calculate_indicators(tqqq_mo)

        # USD ì§€í‘œ
        usd_price = float(usd_wk['Close'].iloc[-1])
        usd_rsi_wk, usd_mdd = calculate_indicators(usd_wk)
        usd_rsi_mo, _ = calculate_indicators(usd_mo)
        
        # ë§¤í¬ë¡œ ë°ì´í„° ë¶„ì„ (Ver 19.3.2)
        vix_val = float(vix['Close'].iloc[-1]) if not vix.empty else 0
        tnx_val = float(tnx['Close'].iloc[-1]) if not tnx.empty else 0
        irx_val = float(irx['Close'].iloc[-1]) if not irx.empty else 0
        yield_spread = tnx_val - irx_val
        
        # VIX 5ì¼ ì•ˆì°© ì—¬ë¶€ (ì°¸ê³ ìš©ìœ¼ë¡œ ìœ ì§€)
        is_vix_trend = False
        if len(vix) >= 5:
            vix_recent_min = vix['Close'].tail(5).min()
            is_vix_trend = (vix_recent_min >= 20.0)
        else:
            is_vix_trend = (vix_val >= 20.0)

        # ê¸ˆë¦¬ì°¨ ì—­ì „ í›„ ì •ìƒí™” (ì°¸ê³ ìš©ìœ¼ë¡œ ìœ ì§€)
        is_spread_normalization = False
        spread_series = None
        if not tnx.empty and not irx.empty:
            spread_series = tnx['Close'] - irx['Close']
            spread_recent = spread_series.tail(126) # 6ê°œì›”
            was_inverted = (spread_recent < 0).any()
            is_positive_now = (spread_series.iloc[-1] >= 0)
            
            if was_inverted and is_positive_now:
                is_spread_normalization = True

        # [Ver 22.5] Winter Protocol & Spring Re-entry (Dual Check)
        is_winter_mode = False
        is_spring_reentry = False
        
        # 1. í˜„ì¬ ìƒíƒœ ì²´í¬ (QQQ & SOXX)
        qqq_ma200_dy = float(qqq_dy['MA200'].iloc[-1])
        qqq_price_dy = float(qqq_dy['Close'].iloc[-1])
        
        soxx_ma200_dy = float(soxx_dy['MA200'].iloc[-1])
        soxx_price_dy = float(soxx_dy['Close'].iloc[-1])
        
        # í•˜ë‚˜ë¼ë„ 200ì¼ì„  ì•„ë˜ë©´ ê²¨ìš¸
        if (not pd.isna(qqq_ma200_dy) and qqq_price_dy < qqq_ma200_dy) or \
           (not pd.isna(soxx_ma200_dy) and soxx_price_dy < soxx_ma200_dy):
            is_winter_mode = True
        
        # 2. Re-entry ê°ì§€ (ì–´ì œëŠ” ê²¨ìš¸ -> ì˜¤ëŠ˜ì€ ë´„ + í•„í„° ì¶©ì¡±)
        # ë‹¨, app.pyëŠ” ì‹¤ì‹œê°„ì´ë¯€ë¡œ 'í˜„ì¬'ê°€ ë´„ì´ì–´ì•¼ Re-entry í›„ë³´ê°€ ë¨
        if not is_winter_mode and len(qqq_dy) >= 4:
             # ì–´ì œ ìƒíƒœ í™•ì¸ (ì–´ì œ ì¢…ê°€ ê¸°ì¤€ í•˜ë‚˜ë¼ë„ ì•„ë˜ì˜€ì–´ì•¼ í•¨)
             yesterday_qqq = float(qqq_dy['Close'].iloc[-2])
             yesterday_qqq_ma = float(qqq_dy['MA200'].iloc[-2])
             yesterday_soxx = float(soxx_dy['Close'].iloc[-2])
             yesterday_soxx_ma = float(soxx_dy['MA200'].iloc[-2])
             
             was_winter_yesterday = (yesterday_qqq < yesterday_qqq_ma) or (yesterday_soxx < yesterday_soxx_ma)
             
             # ë§Œì•½ ì–´ì œë„ ê²¨ìš¸ì´ì—ˆê³ , ì˜¤ëŠ˜ ë¹„ë¡œì†Œ ë‘˜ ë‹¤ ìœ„ë¡œ ì˜¬ë¼ì™”ë‹¤ë©´ -> Re-entry Check ì‹œì‘
             # í•˜ì§€ë§Œ 'Re-entry'ëŠ” ë´„ ì´ˆì… ê¸°ê°„(ì•½ 1ë‹¬)ì„ ì˜ë¯¸í•˜ë¯€ë¡œ, 
             # ì—¬ê¸°ì„œëŠ” "ì™„ì „íˆ ì•ˆì „í•œ ë´„ì¸ê°€?"ë¥¼ íŒë‹¨í•˜ëŠ” í•„í„°ë¥¼ ì ìš©.
             
             # Filter: 3ì¼ ì—°ì† ìœ ì§€ OR 3% ì´ìƒ ìƒìŠ¹ (QQQ ê¸°ì¤€ or ë‘˜ë‹¤? -> QQQ ê¸°ì¤€ ì ìš©)
             # QQQê°€ ì‹œì¥ ëŒ€í‘œì„±ì´ í¬ë¯€ë¡œ QQQ í•„í„°ë¥¼ ë©”ì¸ìœ¼ë¡œ í•¨. (SOXXëŠ” íŠ¸ë¦¬ê±° ì—­í• )
             
             # Filter 1: 3ì¼ ì—°ì† 200ì¼ì„  ìœ„ (Time Filter)
             q_d0 = qqq_dy.iloc[-1]; q_d1 = qqq_dy.iloc[-2]; q_d2 = qqq_dy.iloc[-3]
             is_3days_safe = (q_d0['Close'] > q_d0['MA200']) and \
                             (q_d1['Close'] > q_d1['MA200']) and \
                             (q_d2['Close'] > q_d2['MA200'])
                             
             # Filter 2: 3% ì´ìƒ ìƒìŠ¹ (Price Filter)
             is_3pct_safe = qqq_price_dy >= (qqq_ma200_dy * 1.03)
             
             # í•„í„° í†µê³¼ ì—¬ë¶€
             is_confirmed_spring = is_3days_safe or is_3pct_safe
             
             # Re-entry ëª¨ë“œ í‘œì‹œ ì¡°ê±´:
             # 1. ê¸°ë³¸ ë´„ ì¡°ê±´ ì¶©ì¡± (ë‘˜ ë‹¤ > 200MA) -> ì´ë¯¸ is_winter_mode = False ìƒíƒœ
             # 2. í•„í„°ëŠ” ì•„ì§ í†µê³¼ ëª»í–ˆê±°ë‚˜(ë¶ˆì•ˆ), ê°“ í†µê³¼í•´ì„œ ì§„ì…í•´ì•¼ í•˜ëŠ” ì‹œì .
             
             # ë¡œì§ ë‹¨ìˆœí™”:
             # ê²¨ìš¸ì´ ì•„ë‹ˆë‹¤ = ì¼ë‹¨ ë´„.
             # ê·¼ë° í•„í„°ë¥¼ í†µê³¼ ëª»í–ˆìœ¼ë©´ -> "ë¶ˆì•ˆí•œ ë´„ (Wait)" or "Re-entry ëŒ€ê¸°"
             # í•„í„°ë¥¼ í†µê³¼ í–ˆìœ¼ë©´ -> "Re-entry ì§„ì…" (ì´ˆê¸°) or "ì™„ì—°í•œ ë´„"
             
             # ì—¬ê¸°ì„œëŠ” 'ë´„ì˜ ê·€í™˜' ë©”ì‹œì§€ë¥¼ ë„ìš°ê¸° ìœ„í•´, 
             # "ì–´ì œëŠ” ê²¨ìš¸ì´ì—ˆëŠ”ë° ì˜¤ëŠ˜ì€ ë´„(í•„í„° ë¯¸í™•ì • í¬í•¨)" ì´ë©´ Re-entry ëª¨ë“œë¡œ ê°„ì£¼í•˜ê³ 
             # ë©”ì¸ ë¡œì§ì—ì„œ ì„¸ë¶€ ê°€ì´ë“œë¥¼ ì¤Œ.
             
             if was_winter_yesterday:
                 is_spring_reentry = True
             
             # ì¶”ê°€: ë§Œì•½ ìµœê·¼ 20ì¼ ë‚´ì— ê³¨ë“ í¬ë¡œìŠ¤ê°€ ë°œìƒí–ˆë‹¤ë©´ ê³„ì† Re-entry ëª¨ë“œë¡œ ë³¼ ìˆ˜ë„ ìˆìŒ.
             # í•˜ì§€ë§Œ ë³µì¡ë„ë¥¼ ì¤„ì´ê¸° ìœ„í•´, app.pyì—ì„œëŠ” 'ì–´ì œ vs ì˜¤ëŠ˜' ë³€í™”ë§Œ ê°ì§€í•˜ê±°ë‚˜
             # í˜¹ì€ 'í•„í„° í†µê³¼ ì—¬ë¶€' ì •ë³´ë¥¼ ë¦¬í„´í•´ì„œ ë©”ì¸ì—ì„œ ì²˜ë¦¬.

        # [Ver 20.2] CNN ê³µí¬íƒìš•ì§€ìˆ˜ (Fear & Greed Index)
        fear_greed_value = 50  # ê¸°ë³¸ê°’ (ì¤‘ë¦½)
        fear_greed_text = "Neutral"
        try:
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            }
            response = requests.get("https://production.dataviz.cnn.io/index/fearandgreed/graphdata", 
                                   headers=headers, timeout=5)
            if response.status_code == 200:
                data = response.json()
                fear_greed_value = int(data['fear_and_greed']['score'])
                fear_greed_text = data['fear_and_greed']['rating']
        except:
            try:
                response = requests.get("https://api.alternative.me/fng/?limit=1", timeout=5)
                if response.status_code == 200:
                    data = response.json()
                    fear_greed_value = int(data['data'][0]['value'])
                    fear_greed_text = data['data'][0]['value_classification']
            except:
                pass

        # [Ver 20.2] ë²„í•ì§€ìˆ˜ (Buffett Indicator)
        buffett_indicator = 0
        m2_money_stock = 0
        try:
            wilshire_full = yf.download("^W5000FLT", period="5d", progress=False, auto_adjust=False)
            if not wilshire_full.empty:
                if isinstance(wilshire_full.columns, pd.MultiIndex):
                    wilshire_full.columns = wilshire_full.columns.get_level_values(0)
                wilshire_full_val = float(wilshire_full['Close'].iloc[-1])
                market_cap_trillion = wilshire_full_val / 1000
                us_gdp_trillion = 28.27
                buffett_indicator = (market_cap_trillion / us_gdp_trillion) * 100
                m2_money_stock = 21.17
            else:
                wilshire = yf.download("^W5000", period="5d", progress=False, auto_adjust=False)
                if not wilshire.empty:
                    if isinstance(wilshire.columns, pd.MultiIndex):
                        wilshire.columns = wilshire.columns.get_level_values(0)
                    wilshire_val = float(wilshire['Close'].iloc[-1])
                    market_cap_trillion = wilshire_val / 1000
                    us_gdp_trillion = 28.27
                    buffett_indicator = (market_cap_trillion / us_gdp_trillion) * 100
                    m2_money_stock = 21.17
        except:
            buffett_indicator = 0

        return {
            'qqq_dy': qqq_dy,
            'qqq_wk': qqq_wk,
            'qqq_mo': qqq_mo,
            'qqq_price': qqq_price,
            'qqq_rsi_wk': qqq_rsi_wk,
            'qqq_rsi_mo': qqq_rsi_mo,
            'qqq_mdd': qqq_mdd,
            'tqqq_price': tqqq_price,
            'tqqq_rsi_wk': tqqq_rsi_wk,
            'tqqq_rsi_mo': tqqq_rsi_mo,
            'tqqq_mdd': tqqq_mdd,
            'usd_price': usd_price,
            'usd_rsi_wk': usd_rsi_wk,
            'usd_rsi_mo': usd_rsi_mo,
            'usd_mdd': usd_mdd,
            'usd_krw': current_rate,
            'vix': vix_val,
            'tnx': tnx_val,
            'yield_spread': yield_spread,
            'is_vix_trend': is_vix_trend,
            'is_spread_normalization': is_spread_normalization,
            'is_winter_mode': is_winter_mode,
            'is_spring_reentry': is_spring_reentry,
            'qqq_ma200_dy': qqq_ma200_dy,
            'soxx_dy': soxx_dy,
            'soxx_wk': soxx_wk,
            'soxx_mo': soxx_mo,
            'tqqq_wk': tqqq_wk,
            'tqqq_mo': tqqq_mo,
            'usd_wk': usd_wk,
            'usd_mo': usd_mo,
            'fear_greed_value': fear_greed_value,
            'fear_greed_text': fear_greed_text,
            'buffett_indicator': buffett_indicator,
            'm2_money_stock': m2_money_stock
        }
    except Exception as e:
        # st.error(f"Data Fetch Error: {e}")
        return None

def determine_phase(total_assets):
    if total_assets <= PHASE_CONFIG[0]['limit']: return 0
    for p in range(1, 6):
        if total_assets <= PHASE_CONFIG[p]['limit']: return p
    return 5

def format_krw(value):
    return f"{int(value):,}ì›"

# ==========================================
# 3. ë©”ì¸ ë¡œì§
# ==========================================
st.title("ğŸ”¥ Global Fire CRO System")
st.markdown("**Ver 22.5 (Semiconductor Watch)** | System Owner: **Busan Programmer** | Benchmark: **QQQ & SOXX**")

# ë°ì´í„° ë¡œë“œ (ì´ˆê¸°í™”)
saved_data = load_data()

# Session State ì´ˆê¸°í™” (ì—†ìœ¼ë©´ íŒŒì¼ ê°’ìœ¼ë¡œ)
if "monthly_contribution" not in st.session_state:
    for key, val in saved_data.items():
        if key in saved_data:
            st.session_state[key] = saved_data[key]
        if "qty" in key or "avg" in key or "contribution" in key:
                try:
                    st.session_state[key] = float(st.session_state[key])
                except:
                    pass

with st.expander("ğŸ“œ Master Protocol (ê·œì •ì§‘)", expanded=False):
    st.markdown(PROTOCOL_TEXT)

mkt = get_market_data()

if mkt is not None:
    # ë°ì´í„° ë§¤í•‘
    qqq_price = mkt['qqq_price']
    tqqq_price = mkt['tqqq_price']
    usd_price = mkt['usd_price']
    usd_krw_rate = mkt['usd_krw']
    qqq_rsi = mkt['qqq_rsi_wk']
    qqq_mdd = mkt['qqq_mdd']
    
    # ì°¨íŠ¸ìš© ë°ì´í„°
    df_dy = mkt['qqq_dy']
    df_wk = mkt['qqq_wk']
    df_mo = mkt['qqq_mo']

    tqqq_krw = tqqq_price * usd_krw_rate  # TQQQ í˜„ì¬ê°€ (ì›í™”)
    usd_stock_krw = usd_price * usd_krw_rate # USD í˜„ì¬ê°€ (ì›í™”)

    # --- ì‚¬ì´ë“œë°” (Form ì ìš©ìœ¼ë¡œ ì…ë ¥ ìµœì í™”) ---
    st.sidebar.header("ğŸ“ ìì‚° ì •ë³´")
    st.sidebar.info(f"ğŸ’µ í™˜ìœ¨: **{int(usd_krw_rate):,}ì›/$**")
    
    with st.sidebar.form("asset_form"):
        # ì›”ê¸‰ ì…ë ¥
        st.number_input("ì´ë²ˆ ë‹¬ íˆ¬ì…ê¸ˆ (ì›”ê¸‰)", min_value=0, step=100000, key="monthly_contribution", format="%d")
        st.caption(f"ğŸ‘‰ í™•ì¸: **{format_krw(st.session_state.monthly_contribution)}**")
        
        st.markdown("---")
        
        # Aê³„ì¢Œ
        with st.expander("ğŸ¦ ê³„ì¢Œ A: ê¸ˆê³  (ì¥ê¸°)", expanded=True):
            st.number_input("A: TQQQ ë³´ìœ  ìˆ˜ëŸ‰", min_value=0.0, step=0.01, key="a_tqqq_qty", format="%.2f")
            st.number_input("A: TQQQ í‰ê· ë‹¨ê°€ (KRW)", min_value=0, step=100, key="a_tqqq_avg", format="%d")
            st.markdown("---")
            st.number_input("A: USD ë³´ìœ  ìˆ˜ëŸ‰", min_value=0.0, step=0.01, key="a_usd_qty", format="%.2f")
            st.number_input("A: USD í‰ê· ë‹¨ê°€ (KRW)", min_value=0, step=100, key="a_usd_avg", format="%d")
            
            a_tqqq_eval = st.session_state.a_tqqq_qty * tqqq_krw
            a_usd_eval = st.session_state.a_usd_qty * usd_stock_krw
            st.caption(f"ğŸ“Š TQQQ: **{format_krw(a_tqqq_eval)}** / USD: **{format_krw(a_usd_eval)}**")
            
            st.number_input("A: ì›í™” ì˜ˆìˆ˜ê¸ˆ", min_value=0, step=100000, key="a_cash_krw", format="%d")
            st.caption(f"ğŸ‘‰ {format_krw(st.session_state.a_cash_krw)}")
            
            st.number_input("A: ë‹¬ëŸ¬ ì˜ˆìˆ˜ê¸ˆ", min_value=0, step=100, key="a_cash_usd", format="%d")
            st.caption(f"ğŸ‘‰ ${st.session_state.a_cash_usd:,.2f}")

        # Bê³„ì¢Œ
        with st.expander("âš”ï¸ ê³„ì¢Œ B: ìŠ¤ë‚˜ì´í¼ (ë§¤ë§¤)", expanded=True):
            st.number_input("B: TQQQ ë³´ìœ  ìˆ˜ëŸ‰", min_value=0.0, step=0.01, key="b_tqqq_qty", format="%.2f")
            st.number_input("B: TQQQ í‰ê· ë‹¨ê°€ (KRW)", min_value=0, step=100, key="b_tqqq_avg", format="%d")
            st.markdown("---")
            st.number_input("B: USD ë³´ìœ  ìˆ˜ëŸ‰", min_value=0.0, step=0.01, key="b_usd_qty", format="%.2f")
            st.number_input("B: USD í‰ê· ë‹¨ê°€ (KRW)", min_value=0, step=100, key="b_usd_avg", format="%d")
            
            b_tqqq_eval = st.session_state.b_tqqq_qty * tqqq_krw
            b_usd_eval = st.session_state.b_usd_qty * usd_stock_krw
            st.caption(f"ğŸ“Š TQQQ: **{format_krw(b_tqqq_eval)}** / USD: **{format_krw(b_usd_eval)}**")
            
            st.number_input("B: ì›í™” ì˜ˆìˆ˜ê¸ˆ", min_value=0, step=100000, key="b_cash_krw", format="%d")
            st.caption(f"ğŸ‘‰ {format_krw(st.session_state.b_cash_krw)}")
            
            st.number_input("B: ë‹¬ëŸ¬ ì˜ˆìˆ˜ê¸ˆ", min_value=0, step=100, key="b_cash_usd", format="%d")
            st.caption(f"ğŸ‘‰ ${st.session_state.b_cash_usd:,.2f}")

        # Cê³„ì¢Œ (V17.3 ì¶”ê°€)
        with st.expander("ğŸ›¡ï¸ ê³„ì¢Œ C: ë²™ì»¤ (ì„¸ê¸ˆ/ë¹„ìƒ)", expanded=True):
            st.number_input("C: ì›í™” ì˜ˆìˆ˜ê¸ˆ (ìˆ˜ìµê¸ˆ 22%)", min_value=0, step=100000, key="c_cash_krw", format="%d")
            st.caption(f"ğŸ‘‰ {format_krw(st.session_state.c_cash_krw)}")

        st.markdown("---")
        submit_button = st.form_submit_button("ğŸ’¾ ìì‚° ì •ë³´ ì €ì¥ ë° ì—…ë°ì´íŠ¸", use_container_width=True)
        if submit_button:
            save_data()
            st.success("âœ… ì €ì¥ ì™„ë£Œ!")
    
    # --- ìë™ ì†ìµ íŒë‹¨ ë¡œì§ ---
    tqqq_qty = st.session_state.a_tqqq_qty + st.session_state.b_tqqq_qty
    usd_qty = st.session_state.a_usd_qty + st.session_state.b_usd_qty
    
    tqqq_invested = (st.session_state.a_tqqq_qty * st.session_state.a_tqqq_avg) + \
                    (st.session_state.b_tqqq_qty * st.session_state.b_tqqq_avg)
    usd_invested = (st.session_state.a_usd_qty * st.session_state.a_usd_avg) + \
                   (st.session_state.b_usd_qty * st.session_state.b_usd_avg)
                   
    total_invested_krw = tqqq_invested + usd_invested
    
    total_tqqq_krw = tqqq_qty * tqqq_krw
    total_usd_krw = usd_qty * usd_stock_krw
    total_stock_krw = total_tqqq_krw + total_usd_krw
    
    profit_rate = 0.0
    if total_invested_krw > 0:
        profit_rate = ((total_stock_krw - total_invested_krw) / total_invested_krw) * 100
    
    is_loss = profit_rate < 1.5 if total_invested_krw > 0 else False

    # --- ê³„ì‚° ë¡œì§ ---
    total_cash_krw = (st.session_state.a_cash_krw + st.session_state.b_cash_krw + st.session_state.c_cash_krw) + \
                     ((st.session_state.a_cash_usd + st.session_state.b_cash_usd) * usd_krw_rate)
    total_assets = total_stock_krw + total_cash_krw
    
    # --- 1. ì‹œì¥ ìƒí™©íŒ (ë¨¼ì € í‘œì‹œí•˜ì—¬ ë³€ìˆ˜ ì •ì˜) ---
    st.header("1. ì‹œì¥ ìƒí™©íŒ (Market Status)")
    
    # [Ver 22.5] Winter Protocol Monitor
    with st.expander("ğŸš¨ ê³„ì ˆ ëª¨ë‹ˆí„°ë§ (Season Check)", expanded=True):
        c1, c2 = st.columns([3, 1])
        with c1:
            # 200ì¼ì„  ìƒíƒœ (QQQ & SOXX)
            q_ma = mkt['qqq_dy']['MA200'].iloc[-1]
            q_pr = mkt['qqq_dy']['Close'].iloc[-1]
            q_st = "ğŸŸ¢ ë´„" if q_pr >= q_ma else "â„ï¸ ê²¨ìš¸"
            
            s_ma = mkt['soxx_dy']['MA200'].iloc[-1]
            s_pr = mkt['soxx_dy']['Close'].iloc[-1]
            s_st = "ğŸŸ¢ ë´„" if s_pr >= s_ma else "â„ï¸ ê²¨ìš¸"

            trend_status = "ğŸŸ¢ ë´„ (Spring)"
            if mkt['is_winter_mode']: trend_status = "ğŸ”´ ê²¨ìš¸ (Winter)"
            
            st.markdown(f"""
            **ì‹œìŠ¤í…œ ê³„ì ˆ íŒë‹¨:**
            *   **ì¢…í•© ìƒíƒœ:** **[{trend_status}]** (ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ê²¨ìš¸ì´ë©´ ê²¨ìš¸)
            *   **QQQ:** {q_st} (${q_pr:.2f} vs 200ì„  ${q_ma:.2f})
            *   **SOXX:** {s_st} (${s_pr:.2f} vs 200ì„  ${s_ma:.2f})
            """)
        with c2:
            season_manual = st.checkbox("â„ï¸ ê²¨ìš¸ ê°•ì œ ì„ í¬", value=False, help="ì‹œìŠ¤í…œ íŒë‹¨ ì™¸ì— CRO íŒë‹¨ìœ¼ë¡œ ê²¨ìš¸ ëª¨ë“œë¥¼ ê°•ì œí•  ë•Œ ì²´í¬")

    # Phase ê²°ì • ë° ëª¨ë“œ ì„¤ì •
    current_phase = determine_phase(total_assets)
    base_target_stock = PHASE_CONFIG[current_phase]['target_stock']
    base_target_cash = PHASE_CONFIG[current_phase]['target_cash']
    
    # [Ver 22.5] ê²¨ìš¸ ëª¨ë“œ ë°œë™ ë¡œì§
    is_winter = mkt['is_winter_mode'] or season_manual
    
    if is_winter: 
        if not season_manual:
            st.toast(f"â„ï¸ ê²¨ìš¸ì´ ì™”ìŠµë‹ˆë‹¤! (200ì¼ì„  ë¶•ê´´) ë°©ì–´ íƒœì„¸ ì „í™˜.", icon="ğŸ¥¶")
        target_stock_ratio = 0.5 
        target_cash_ratio = 0.5 
        rsi_sell_threshold = 75 
        mode_label = "â„ï¸ ê²¨ìš¸ ëª¨ë“œ (Winter Protocol)"
    else:
        # ë´„ ëª¨ë“œ (ì •ìƒ Glide Path)
        target_stock_ratio = base_target_stock
        target_cash_ratio = base_target_cash
        rsi_sell_threshold = 80
        mode_label = "ğŸŒ¸ ë´„ ëª¨ë“œ (Spring Protocol)"
        
        # [Priority 2.5] ë´„ì˜ ê·€í™˜ ì²´í¬
        if mkt['is_spring_reentry']:
            # Re-entry í•„í„° í†µê³¼ ì—¬ë¶€ í™•ì¸ (3ì¼ ìœ ì§€ or 3% ìƒìŠ¹)
            q_d = mkt['qqq_dy']
            q_ma = q_d['MA200'].iloc[-1]
            q_pr = q_d['Close'].iloc[-1]
            
            # í•„í„° 1: 3ì¼ ì—°ì†
            d0=q_d.iloc[-1]; d1=q_d.iloc[-2]; d2=q_d.iloc[-3]
            is_3days = (d0['Close']>d0['MA200']) and (d1['Close']>d1['MA200']) and (d2['Close']>d2['MA200'])
            
            # í•„í„° 2: 3% ìƒìŠ¹
            is_3pct = q_pr >= (q_ma * 1.03)
            
            if is_3days or is_3pct:
                st.toast("ğŸŒ± ë´„ì˜ ê·€í™˜! í•„í„° í†µê³¼ (Re-entry Confirmed).", icon="âœ…")
                mode_label = "ğŸŒ± ë´„ì˜ ê·€í™˜ (Re-entry Confirmed)"
            else:
                st.toast("âš ï¸ ë´„ì˜ ê·€í™˜ ê°ì§€ (ê²€ì¦ ëŒ€ê¸°ì¤‘...)", icon="â³")
                mode_label = "â³ ë´„ì˜ ê·€í™˜ (ê²€ì¦ ëŒ€ê¸°: 3ì¼ or +3%)"
    
    current_stock_ratio = total_stock_krw / total_assets if total_assets > 0 else 0
    current_cash_ratio = total_cash_krw / total_assets if total_assets > 0 else 0

    # Helper for labels
    def get_rsi_status(rsi):
        if rsi >= 80: return "ğŸš¨ ê´‘ê¸°"
        elif rsi >= 75: return "ğŸ”¥ ê³¼ì—´"
        elif rsi < 60: return "ğŸ’° ê¸°íšŒ"
        return "í‘œì¤€"

    def get_mdd_status(mdd):
        return "ğŸ“‰ ìœ„ê¸°" if mdd <= -0.2 else "âœ… ì•ˆì •"

    # QQQ Info
    q1, q2, q3, q4 = st.columns(4)
    q1.metric("QQQ í˜„ì¬ê°€", f"${qqq_price:.2f} ({format_krw(qqq_price*usd_krw_rate)})")
    q2.metric("QQQ ì›”ë´‰ RSI", f"{mkt['qqq_rsi_mo']:.1f}", "Month Trend")
    q3.metric("QQQ ì£¼ë´‰ RSI", f"{qqq_rsi:.1f}", get_rsi_status(qqq_rsi))
    q4.metric("QQQ MDD", f"{qqq_mdd*100:.2f}%", get_mdd_status(qqq_mdd))
    
    # TQQQ Info
    t1, t2, t3, t4 = st.columns(4)
    t1.metric("TQQQ í˜„ì¬ê°€", f"${tqqq_price:.2f} ({format_krw(tqqq_price*usd_krw_rate)})")
    t2.metric("TQQQ ì›”ë´‰ RSI", f"{mkt['tqqq_rsi_mo']:.1f}", "Month Trend")
    t3.metric("TQQQ ì£¼ë´‰ RSI", f"{mkt['tqqq_rsi_wk']:.1f}", get_rsi_status(mkt['tqqq_rsi_wk']))
    t4.metric("TQQQ MDD", f"{mkt['tqqq_mdd']*100:.2f}%", get_mdd_status(mkt['tqqq_mdd']))

    # USD Info
    u1, u2, u3, u4 = st.columns(4)
    u1.metric("USD í˜„ì¬ê°€", f"${mkt['usd_price']:.2f} ({format_krw(mkt['usd_price']*usd_krw_rate)})")
    u2.metric("USD ì›”ë´‰ RSI", f"{mkt['usd_rsi_mo']:.1f}", "Month Trend")
    u3.metric("USD ì£¼ë´‰ RSI", f"{mkt['usd_rsi_wk']:.1f}", get_rsi_status(mkt['usd_rsi_wk']))
    u4.metric("USD MDD", f"{mkt['usd_mdd']*100:.2f}%", get_mdd_status(mkt['usd_mdd']))

    # Macro Info (ì°¸ê³ ìš©)
    m1, m2, m3, m4, m5, m6 = st.columns(6)
    vix = mkt['vix']
    vix_label = "âœ… ì•ˆì •" if vix < 20 else ("ğŸš¨ ê³µí¬" if vix > 30 else "ğŸ›¡ï¸ ë°©ì–´")
    m1.metric("VIX (ë³€ë™ì„±)", f"{vix:.2f}", vix_label)
    
    tnx = mkt['tnx']
    m2.metric("US 10Y (êµ­ì±„ê¸ˆë¦¬)", f"{tnx:.2f}%")
    
    spread = mkt['yield_spread']
    spread_msg = "âœ… ì •ìƒ" if spread > 0 else "ğŸš¨ ì—­ì „"
    if mkt['is_spread_normalization']: spread_msg = "âš ï¸ ì •ìƒí™” ì¤‘"
    m3.metric("10Y-3M ê¸ˆë¦¬ì°¨", f"{spread:.2f}%p", spread_msg)
    
    fg_val = mkt['fear_greed_value']
    fg_text = mkt['fear_greed_text']
    fg_emoji = "ğŸ˜ ì¤‘ë¦½" # Default
    if fg_val <= 25: fg_emoji = "ğŸ˜± ê·¹ë„ ê³µí¬"
    elif fg_val <= 45: fg_emoji = "ğŸ˜° ê³µí¬"
    elif fg_val <= 55: fg_emoji = "ğŸ˜ ì¤‘ë¦½"
    elif fg_val <= 75: fg_emoji = "ğŸ˜Š íƒìš•"
    else: fg_emoji = "ğŸ¤‘ ê·¹ë„ íƒìš•"
    m4.metric("ê³µí¬íƒìš•ì§€ìˆ˜", f"{fg_val}", fg_emoji)
    
    buffett = mkt['buffett_indicator']
    buffett_label = "âœ… ì ì •"
    if buffett > 200: buffett_label = "ğŸ’¥ ì—­ì‚¬ì  ë²„ë¸”"
    elif buffett > 135: buffett_label = "ğŸš¨ ê³ í‰ê°€"
    m5.metric("ë²„í•ì§€ìˆ˜", f"{buffett:.1f}%", buffett_label)
    
    m6.empty() 

    # --- 2. í¬íŠ¸í´ë¦¬ì˜¤ ì§„ë‹¨ ---
    st.markdown("---")
    st.header("2. í¬íŠ¸í´ë¦¬ì˜¤ ì§„ë‹¨ (Diagnosis)")
    
    if current_phase < 5:
        prev_limit = PHASE_CONFIG[current_phase-1]['limit'] if current_phase > 1 else 0
        next_limit = PHASE_CONFIG[current_phase]['limit']
        progress = (total_assets - prev_limit) / (next_limit - prev_limit)
        progress = max(0.0, min(1.0, progress))
        st.progress(progress, text=f"ğŸš€ Level Up ({PHASE_CONFIG[current_phase+1]['name']}) ì§„í–‰ë¥ : {progress*100:.1f}%")
    else:
        st.progress(1.0, text="ğŸ† Final Phase ë‹¬ì„±! (ì€í‡´ ì¤€ë¹„ ì™„ë£Œ)")

    # 1ë‹¨: í†µí•© ì •ë³´
    st.markdown("### ğŸ“Š í†µí•© í¬íŠ¸í´ë¦¬ì˜¤")
    row1_col1, row1_col2, row1_col3, row1_col4 = st.columns(4)
    phase_info = PHASE_CONFIG[current_phase]
    
    row1_col1.metric("í˜„ì¬ Phase", f"{phase_info['name']}", f"{mode_label}")
    row1_col2.metric("ì´ ìì‚°", format_krw(total_assets))
    row1_col3.metric("í†µí•© íˆ¬ì ì›ê¸ˆ", format_krw(total_invested_krw))
    
    if total_invested_krw > 0:
        st_emoji = "ğŸ”´" if not is_loss else "ğŸ”µ"
        row1_col4.metric("í†µí•© ìˆ˜ìµë¥ ", f"{profit_rate:.2f}%", f"{st_emoji} ìƒíƒœ")
    else:
        row1_col4.metric("í†µí•© ìˆ˜ìµë¥ ", "0%", "ëŒ€ê¸°")
    
    row2_col1, row2_col2, row2_col3, row2_col4 = st.columns(4)
    row2_col1.metric("ì´ ì£¼ì‹ í‰ê°€ê¸ˆ", format_krw(total_stock_krw))
    row2_col2.metric("ì´ í˜„ê¸ˆ ë³´ìœ ì•¡", format_krw(total_cash_krw))
    
    tqqq_ratio_display = total_tqqq_krw / total_stock_krw if total_stock_krw > 0 else 0.5
    usd_ratio_display = total_usd_krw / total_stock_krw if total_stock_krw > 0 else 0.5
    tqqq_pct = int(tqqq_ratio_display * 100)
    usd_pct = int(usd_ratio_display * 100)
    row2_col3.metric("ì£¼ì‹ ë¹„ì¤‘", 
                     f"{current_stock_ratio*100:.1f}%", 
                     f"ëª©í‘œ: {target_stock_ratio*100:.0f}% (TQ {tqqq_pct}:{usd_pct} USD)")
    row2_col4.metric("í˜„ê¸ˆ ë¹„ì¤‘", f"{current_cash_ratio*100:.1f}%", f"ëª©í‘œ: {target_cash_ratio*100:.0f}%")

    # 2ë‹¨: ìƒì„¸ ì •ë³´
    st.markdown("### ğŸš€ TQQQ & USD ìƒì„¸")
    c_t1, c_t2, c_t3, c_u1, c_u2, c_u3 = st.columns(6)
    
    tqqq_avg = tqqq_invested / tqqq_qty if tqqq_qty > 0 else 0
    tqqq_profit = ((total_tqqq_krw - tqqq_invested) / tqqq_invested * 100) if tqqq_invested > 0 else 0
    c_t1.metric("TQQQ ìˆ˜ëŸ‰", f"{tqqq_qty:.2f}ì£¼")
    c_t2.metric("TQQQ í‰ê°€ê¸ˆ", format_krw(total_tqqq_krw))
    c_t3.metric("TQQQ ìˆ˜ìµë¥ ", f"{tqqq_profit:.2f}%", "ğŸ”´" if tqqq_profit >= 0 else "ğŸ”µ")

    usd_avg = usd_invested / usd_qty if usd_qty > 0 else 0
    usd_profit = ((total_usd_krw - usd_invested) / usd_invested * 100) if usd_invested > 0 else 0
    c_u1.metric("USD ìˆ˜ëŸ‰", f"{usd_qty:.2f}ì£¼")
    c_u2.metric("USD í‰ê°€ê¸ˆ", format_krw(total_usd_krw))
    c_u3.metric("USD ìˆ˜ìµë¥ ", f"{usd_profit:.2f}%", "ğŸ”´" if usd_profit >= 0 else "ğŸ”µ")

    st.markdown("---")
    if is_loss: st.error("ğŸ›‘ [ì†ì‹¤ ì¤‘] ì ˆëŒ€ ë°©íŒ¨ ê°€ë™: ë§¤ë„ ê¸ˆì§€ (í—Œë²• ì œ1ì¡°)")
    else: st.success("âœ… [ìˆ˜ìµ ì¤‘] ì •ìƒ ë¡œì§ ê°€ë™")

    # --- 3. CRO ì‹¤í–‰ ëª…ë ¹ ---
    st.markdown("---")
    st.header("3. CRO ì‹¤í–‰ ëª…ë ¹ (Action Protocol)")
    
    # 1. ì›”ê¸‰ ë§¤ìˆ˜ ê°€ì´ë“œ
    monthly_msg = ""
    monthly_color = "blue"
    
    # [Ver 22.3] Winter Protocol: ê²¨ìš¸ì—” ë§¤ìˆ˜ ê¸ˆì§€ (ë‹¨, -25% ìŠ¤ë‚˜ì´í•‘ ì‹œ ì°¸ì—¬ ê°€ëŠ¥)
    if is_winter:
        if qqq_mdd <= -0.25:
             buy_amt_monthly = st.session_state.monthly_contribution
             monthly_msg = f"ğŸ“‰ **ê²¨ìš¸ì¥ ìŠ¤ë‚˜ì´í•‘ (MDD -25%â†“)**: ì›”ê¸‰ 100% ({format_krw(buy_amt_monthly)}) TQQQ & USD ë¶„í•  ë§¤ìˆ˜ (ìŠ¤ë‚˜ì´í¼ ì§€ì›ì‚¬ê²©)."
             monthly_color = "red"
        else:
             monthly_msg = f"â„ï¸ **ê²¨ìš¸ (Winter)**: ë§¤ìˆ˜ ê¸ˆì§€. ì›”ê¸‰ 100% í˜„ê¸ˆ(ë‹¬ëŸ¬)ìœ¼ë¡œ ì ë¦½."
    else:
        # ë´„ (Spring) - ê¸°ì¡´ ë¡œì§
        if qqq_rsi >= rsi_sell_threshold:
             monthly_msg = f"ğŸ’¤ **ê³¼ì—´ (RSI {rsi_sell_threshold}+)**: ë§¤ìˆ˜ ê¸ˆì§€. ì›”ê¸‰ì€ í˜„ê¸ˆ ì ë¦½."
        elif qqq_rsi >= 60:
             buy_amt_monthly = st.session_state.monthly_contribution * target_stock_ratio
             monthly_msg = f"âœ… **í‘œì¤€**: ì›”ê¸‰ì˜ {target_stock_ratio*100:.0f}% ({format_krw(buy_amt_monthly)}) ë§¤ìˆ˜."
        else:
             # ê¸°íšŒ êµ¬ê°„
             if total_cash_krw > (total_assets * target_cash_ratio):
                 buy_amt_monthly = (st.session_state.monthly_contribution * target_stock_ratio) * 1.5
                 monthly_msg = f"ğŸ’° **ê¸°íšŒ (Cash Rich)**: 1.5ë°° ê°€ì† ({format_krw(buy_amt_monthly)}) ë§¤ìˆ˜."
             else:
                 squeeze_ratio = min(target_stock_ratio + 0.1, 1.0)
                 buy_amt_monthly = st.session_state.monthly_contribution * squeeze_ratio
                 monthly_msg = f"ğŸ©¸ **ê¸°íšŒ (Squeeze)**: ì¥ì–´ì§œê¸° ({format_krw(buy_amt_monthly)}) ë§¤ìˆ˜."

    # 2. ë³´ìœ  ìì‚° ìš´ìš©
    final_action = ""
    detail_msg = ""
    action_color = "blue"
    
    # Dual Rebalance Check
    tqqq_ratio = total_tqqq_krw / total_stock_krw if total_stock_krw > 0 else 0.5
    need_dual_rebalance = False
    dual_msg = ""
    if abs(tqqq_ratio - 0.5) > 0.1: # 10%p ì°¨ì´
        need_dual_rebalance = True
        if tqqq_ratio > 0.5:
            dual_msg = "âš–ï¸ **ë“€ì–¼ ë¦¬ë°¸ëŸ°ì‹±:** TQQQ ì¼ë¶€ ë§¤ë„ -> USD ë§¤ìˆ˜"
        else:
            dual_msg = "âš–ï¸ **ë“€ì–¼ ë¦¬ë°¸ëŸ°ì‹±:** USD ì¼ë¶€ ë§¤ë„ -> TQQQ ë§¤ìˆ˜"

    # Action Logic
    if is_winter:
        # ê²¨ìš¸ í–‰ë™ ê°•ë ¹
        if current_cash_ratio < 0.5:
             sell_needed = (total_assets * 0.5) - total_cash_krw
             final_action = "â„ï¸ WINTER DEFENSE (í˜„ê¸ˆ í™•ë³´)"
             detail_msg = f"ê²¨ìš¸ì´ ì™”ìŠµë‹ˆë‹¤. í˜„ê¸ˆ ë¹„ì¤‘ 50% ë¯¸ë§Œì…ë‹ˆë‹¤.\n{format_krw(sell_needed)} ë§¤ë„í•˜ì—¬ í˜„ê¸ˆ 50%ë¥¼ ë§ì¶”ì‹­ì‹œì˜¤."
             action_color = "red"
        else:
             final_action = "â„ï¸ WINTER HOLD (ê´€ë§)"
             detail_msg = "ê²¨ìš¸ì´ì§€ë§Œ ì´ë¯¸ í˜„ê¸ˆ ë¹„ì¤‘ì´ 50% ì´ìƒì…ë‹ˆë‹¤. ì¶”ê°€ ë§¤ë„ ì—†ì´ ê´€ë§í•˜ì‹­ì‹œì˜¤."
             
        # ê²¨ìš¸ì—ë„ ìŠ¤ë‚˜ì´í•‘ì€ ì‘ë™ (-25% ë¶€í„°)
        if qqq_mdd <= -0.25:
             # ì—­í”¼ë¼ë¯¸ë“œ ë¹„ì¤‘ (Ver 22.3)
             input_cash = 0
             ratio_str = ""
             if qqq_mdd <= -0.45:
                 input_cash = total_cash_krw * 0.4
                 ratio_str="40% (Last Bullet)"
             elif qqq_mdd <= -0.35:
                 input_cash = total_cash_krw * 0.3
                 ratio_str="30%"
             elif qqq_mdd <= -0.25:
                 input_cash = total_cash_krw * 0.2
                 ratio_str="20% (Entry)"
            
             final_action = f"ğŸ“‰ WINTER SNIPER ({ratio_str})"
             detail_msg = f"ê²¨ìš¸ì¥ í­ë½(MDD {qqq_mdd*100:.1f}%) ê¸°íšŒì…ë‹ˆë‹¤. í˜„ê¸ˆ {ratio_str} ({format_krw(input_cash)}) íˆ¬ì…."
             action_color = "green"

    else:
        # ë´„ (Spring) í–‰ë™ ê°•ë ¹
        
        # [Priority 2.5] ë´„ì˜ ê·€í™˜ (Spring Re-entry)
        # ì´ë²ˆ ì£¼ê°€ ë´„ìœ¼ë¡œ ë°”ë€ 'ì²« ì£¼'ë¼ë©´ ë¶„í•  ë§¤ìˆ˜ ê°€ì´ë“œ ì¶œë ¥
        if mkt['is_spring_reentry']:
            input_cash_total = (total_assets * target_stock_ratio) - total_stock_krw
            input_cash_weekly = input_cash_total / 4
            
            # í•„í„° ìƒíƒœ í™•ì¸
            q_d = mkt['qqq_dy']
            q_ma = q_d['MA200'].iloc[-1]
            q_pr = q_d['Close'].iloc[-1]
            is_3days = (q_d.iloc[-1]['Close']>q_d.iloc[-1]['MA200']) and (q_d.iloc[-2]['Close']>q_d.iloc[-2]['MA200']) and (q_d.iloc[-3]['Close']>q_d.iloc[-3]['MA200'])
            is_3pct = q_pr >= (q_ma * 1.03)
            
            if not (is_3days or is_3pct):
                final_action = "â³ RE-ENTRY WAIT (ê²€ì¦ ëŒ€ê¸°)"
                detail_msg = f"ê²¨ìš¸ ì¢…ë£Œ ê°ì§€ë¨. í•˜ì§€ë§Œ íœ©ì†Œ ë°©ì§€ë¥¼ ìœ„í•´ í•„í„° ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.\n\nğŸ‘‰ **ëŒ€ê¸° ì¡°ê±´:** (1) 3ì¼ ìœ ì§€ OR (2) 3% ìƒìŠ¹\ní˜„ì¬ëŠ” ê´€ë§í•˜ì‹­ì‹œì˜¤."
                action_color = "orange"
            else:
                final_action = "ğŸŒ± SPRING RE-ENTRY (ë´„ì˜ ê·€í™˜)"
                
                if qqq_rsi > 75:
                    detail_msg = f"í•„í„° í†µê³¼(ì§„ì§œ ë´„). 4ì£¼ ë¶„í•  ì§„ì… ì‹œì ì´ë‚˜, RSI({qqq_rsi:.1f}) ê³¼ì—´ë¡œ ê¸ˆì£¼ëŠ” Skipí•©ë‹ˆë‹¤. (ë‹¤ìŒ ì£¼ ì´ì›”)"
                    action_color = "orange"
                else:
                    detail_msg = f"í•„í„° í†µê³¼(ì§„ì§œ ë´„). í˜„ê¸ˆ 4ì£¼ ë¶„í•  íˆ¬ì…ì„ ì‹œì‘í•©ë‹ˆë‹¤.\n\nğŸ‘‰ **ê¸ˆì£¼ íˆ¬ì…ì•¡ (1/4):** {format_krw(input_cash_weekly)} ë§¤ìˆ˜\nâš ï¸ 200ì¼ì„  ë‹¤ì‹œ ê¹¨ì§€ë©´ ì¦‰ì‹œ ì¤‘ë‹¨ ë° í˜„ê¸ˆ 50% í™•ë³´ (Abort Mission)."
                    action_color = "green"

        elif qqq_rsi >= 80:
            target_cash_panic = target_cash_ratio + 0.1
            sell_needed = (total_assets * target_cash_panic) - total_cash_krw
            if sell_needed > 0:
                final_action = "ğŸš¨ SPRING FEVER (ê´‘ê¸° ë§¤ë„)"
                detail_msg = f"RSI 80 ëŒíŒŒ. í˜„ê¸ˆ {format_krw(sell_needed)} ì¶”ê°€ í™•ë³´ (Target + 10%)."
                action_color = "red"
            else:
                final_action = "âœ… HOLD (í˜„ê¸ˆ ì¶©ë¶„)"
                detail_msg = "ê´‘ê¸° êµ¬ê°„ì´ë‚˜ í˜„ê¸ˆì´ ì¶©ë¶„í•©ë‹ˆë‹¤."

        elif qqq_mdd <= -0.15:
             # ë´„ì—” -15% ë¶€í„° ìŠ¤ë‚˜ì´í•‘
             input_cash = 0
             ratio_str = ""
             if qqq_mdd <= -0.45:
                 input_cash = total_cash_krw * 0.4
                 ratio_str="40%"
             elif qqq_mdd <= -0.35:
                 input_cash = total_cash_krw * 0.3
                 ratio_str="30%"
             elif qqq_mdd <= -0.25:
                 input_cash = total_cash_krw * 0.2
                 ratio_str="20%"
             elif qqq_mdd <= -0.15:
                 input_cash = total_cash_krw * 0.1 # ë´„ì—” 10% ì§¤ì§¤ì´
                 ratio_str="10% (Spring Dip)"
            
             final_action = f"ğŸ“‰ SPRING SNIPER ({ratio_str})"
             detail_msg = f"ë´„ ì‹œì¦Œ ì¡°ì •(MDD {qqq_mdd*100:.1f}%)ì…ë‹ˆë‹¤. í˜„ê¸ˆ {ratio_str} ({format_krw(input_cash)}) íˆ¬ì…."
             action_color = "green"

        elif current_stock_ratio > (target_stock_ratio + 0.1):
            sell_amt = total_stock_krw - (total_assets * target_stock_ratio)
            final_action = "âš–ï¸ REBALANCE SELL"
            detail_msg = f"ë¹„ì¤‘ ì´ˆê³¼. {format_krw(sell_amt)} ë§¤ë„."
            action_color = "orange"
        
        elif need_dual_rebalance:
            final_action = "âš–ï¸ DUAL REBALANCE"
            detail_msg = dual_msg
            action_color = "orange"
            
        else:
            final_action = "ğŸ§˜ STABLING (ê´€ë§)"
            detail_msg = "íŠ¹ì´ì‚¬í•­ ì—†ìŒ. í¬íŠ¸í´ë¦¬ì˜¤ ìœ ì§€."

    # ì†ì‹¤ ë°©ì–´ (í—Œë²•)
    if is_loss and ("ë§¤ë„" in final_action or "SELL" in final_action or "DEFENSE" in final_action):
        final_action = "ğŸ›¡ï¸ LOSS PROTECTION (ì ˆëŒ€ ë°©ì–´)"
        detail_msg = f"ì‹œìŠ¤í…œ ë§¤ë„ ì‹ í˜¸ê°€ ìˆìœ¼ë‚˜, **í˜„ì¬ ì†ì‹¤ ì¤‘**ì´ë¯€ë¡œ í—Œë²• ì œ1ì¡°ì— ì˜ê±°í•˜ì—¬ **ë§¤ë„ë¥¼ ê¸ˆì§€(HOLD)**í•©ë‹ˆë‹¤."
        action_color = "red"

    st.info(f"ğŸ’¡ **ë³´ìœ  ìì‚° ì‹¤í–‰ (Asset Action):** {final_action}")
    
    if action_color == "red": st.error(detail_msg)
    elif action_color == "green": st.success(detail_msg)
    elif action_color == "orange": st.warning(detail_msg)
    else: st.info(detail_msg)
    
    st.markdown("---")
    st.caption("ğŸ“… **ì›”ê¸‰ íˆ¬ì… ì§€ì¹¨ (Monthly Input)**")
    if monthly_color == "red": st.error(monthly_msg)
    else: st.info(monthly_msg)

    # --- 4. ì°¨íŠ¸ (ì¢…ëª©ë³„ ë…ë¦½ Expander) ---
    st.markdown("---")
    st.header("4. ğŸ“Š ì°¨íŠ¸ ë¶„ì„ (Technical Charts)")
    
    # ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ê³µí†µ)
    def draw_chart(df, title):
        if df is None or df.empty:
            st.warning(f"ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤ ({title})")
            return

        fig = go.Figure(data=[go.Candlestick(x=df.index, open=df['Open'], high=df['High'], low=df['Low'], close=df['Close'], name='Candle')])
        
        # MA Line Colors (40ì¼ì„ , 200ì¼ì„  í¬í•¨)
        ma_colors = {'MA20': 'orange', 'MA40': 'purple', 'MA60': 'blue', 'MA200': 'red'}
        
        for ma_name, color in ma_colors.items():
            if ma_name in df.columns:
                width = 2 if ma_name == 'MA40' else 1
                dash = 'dot' if ma_name == 'MA200' else 'solid'
                fig.add_trace(go.Scatter(x=df.index, y=df[ma_name], line=dict(color=color, width=width, dash=dash), name=ma_name))
        
        fig.update_layout(title=title, height=400, margin=dict(l=20, r=20, t=40, b=20), xaxis_rangeslider_visible=False)
        st.plotly_chart(fig, use_container_width=True)
        
        if 'RSI' in df.columns:
            fig_rsi = go.Figure(data=[go.Scatter(x=df.index, y=df['RSI'], line=dict(color='purple'))])
            fig_rsi.add_hline(y=80, line_color="red", line_dash="dash")
            fig_rsi.add_hline(y=60, line_color="green", line_dash="dash")
            fig_rsi.update_layout(title=f'{title} - RSI', height=200, yaxis_range=[0, 100], margin=dict(l=20, r=20, t=40, b=20))
            st.plotly_chart(fig_rsi, use_container_width=True)

    # ğŸ“Š QQQ ì°¨íŠ¸
    with st.expander("ğŸ“Š QQQ (ë‚˜ìŠ¤ë‹¥ 100) ì°¨íŠ¸ í™•ì¸", expanded=False):
        tab1, tab2, tab3 = st.tabs(["ì¼ë´‰ (Daily)", "ì£¼ë´‰ (Weekly)", "ì›”ë´‰ (Monthly)"])
        with tab1:
            draw_chart(mkt['qqq_dy'], "QQQ Daily Chart")
        with tab2:
            draw_chart(mkt['qqq_wk'], "QQQ Weekly Chart")
        with tab3:
            draw_chart(mkt['qqq_mo'], "QQQ Monthly Chart")
    
    # ğŸ“Š SOXX ì°¨íŠ¸
    with st.expander("ğŸ“Š SOXX (ë°˜ë„ì²´ ì§€ìˆ˜) ì°¨íŠ¸ í™•ì¸", expanded=False):
        tab1, tab2, tab3 = st.tabs(["ì¼ë´‰ (Daily)", "ì£¼ë´‰ (Weekly)", "ì›”ë´‰ (Monthly)"])
        with tab1:
            draw_chart(mkt['soxx_dy'], "SOXX Daily Chart")
        with tab2:
            draw_chart(mkt['soxx_wk'], "SOXX Weekly Chart")
        with tab3:
            draw_chart(mkt['soxx_mo'], "SOXX Monthly Chart")
    
    # ğŸ“Š TQQQ ì°¨íŠ¸
    with st.expander("ğŸ“Š TQQQ (3ë°° ë ˆë²„ë¦¬ì§€) ì°¨íŠ¸ í™•ì¸", expanded=False):
        tab1, tab2 = st.tabs(["ì£¼ë´‰ (Weekly)", "ì›”ë´‰ (Monthly)"])
        with tab1:
            draw_chart(mkt['tqqq_wk'], "TQQQ Weekly Chart")
        with tab2:
            draw_chart(mkt['tqqq_mo'], "TQQQ Monthly Chart")
        st.caption("â„¹ï¸ TQQQ ì¼ë´‰ ë°ì´í„°ëŠ” ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
    
    # ğŸ“Š USD ì°¨íŠ¸
    with st.expander("ğŸ“Š USD (ë°˜ë„ì²´ 2ë°°) ì°¨íŠ¸ í™•ì¸", expanded=False):
        tab1, tab2 = st.tabs(["ì£¼ë´‰ (Weekly)", "ì›”ë´‰ (Monthly)"])
        with tab1:
            draw_chart(mkt['usd_wk'], "USD Weekly Chart")
        with tab2:
            draw_chart(mkt['usd_mo'], "USD Monthly Chart")
        st.caption("â„¹ï¸ USD ì¼ë´‰ ë°ì´í„°ëŠ” ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")

    # --- 5. ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ & ì½”ì–´ ë¡œì§ ---
    st.markdown("---")
    with st.expander("ğŸ“… ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸", expanded=False):
        try:
            with open("ReleaseNotes.md", "r", encoding="utf-8") as f:
                st.markdown(f.read())
        except: pass
    
    with st.expander("ğŸ›ï¸ ì½”ì–´ ë¡œì§ (Master Protocol)", expanded=False):
        try:
            with open("TradingCoreLogic.md", "r", encoding="utf-8") as f:
                st.markdown(f.read())
        except: pass

else:
    st.warning("ë°ì´í„° ë¡œë”© ì¤‘... (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)")
